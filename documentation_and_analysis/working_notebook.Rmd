---
title: "Final Project workbook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r include=FALSE}
# load libraries
library(tidyverse)
library(janitor)
library(jsonlite)
library(here)
library(lubridate)
library(leaflet)
library(tsibbledata)
library(tsibble)
library(elevatr)
library(rgdal)
library(circlize)
library(ggraph)
library(infer)




```

```{r message=FALSE}
# Load in data
hires_2019_clean <- read_csv('../clean_data/hires_2019_clean.csv')
rain_2019_clean <- read_csv('../clean_data/rain_2019_clean.csv')

```



```{r}
# number of stations in total: 164
hires_2019_clean %>% 
  distinct(start_station_id) %>% 
  count()

hires_2019_clean %>% 
  distinct(end_station_id) %>% 
  count()
```


```{r}
# visualising use by month
hires_2019_clean %>% 
  mutate(month = month(start_date, label = TRUE), .before = 1) %>% 
  group_by(month) %>% 
  summarise(count = n()) %>%
  ggplot() +
  aes(x = month, y = count) +
  geom_col(fill = "#F27F1B") +
  geom_text(aes(label = count), vjust = 2, colour = "white", size = 3.5) +
  labs(x = "\nMonth",
       y = "Number of journeys\n",
       title = "Total number of bike journeys by month (2019)",
       subtitle = "Total = 124446 journeys\n\n") +
  scale_y_discrete(expand = c(0,1), limits = c(0, 5000, 10000, 15000)) +
  theme_minimal() +
  theme(title = element_text(size = 12),
        axis.text = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))

```
```{r}
# create smaller dataset for map
map_data <- hires_2019_clean %>% 
  select(start_station_longitude, start_station_latitude, start_station_id, start_station_name, start_elevation) %>% 
  distinct(start_station_id, .keep_all = TRUE)
```


```{r}
map_data %>% 
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addTiles(providers$CartoDB.Positron) %>%
  addCircles(lng = ~start_station_longitude,
             lat = ~start_station_latitude,
             color = "#F27F1B",
             popup = ~paste0("Station ID: ", start_station_id,
                             "<br>Name: ", start_station_name,
                             "<br>Elevation (m): ", start_elevation))
```

### Most popular stations


```{r}
# top 10 start and end stations
hires_2019_clean %>% 
  select(start_station_id, start_station_name, start_station_description, start_elevation) %>% 
  count(start_station_id, start_station_name, start_station_description, start_elevation) %>% 
  arrange(desc(n)) %>% 
  head(10)

hires_2019_clean %>% 
  select(end_station_id, end_station_name, end_station_description, end_elevation) %>% 
  count(end_station_id, end_station_name, end_station_description, end_elevation) %>% 
  arrange(desc(n)) %>%
  head(10)
```


```{r}
hires_2019_clean %>% 
  select(start_station_id, end_station_id) %>% 
  filter(start_station_id == c("248", "259", "265", "289", "257", "262", "249", "247", "171", "183"), 
         end_station_id == c("262", "257", "250", "265", "248", "358", "259", "183", "171", "258")) %>% 
  chordDiagram(scale = TRUE)
  
  #chordDiagram(annotationTrack = c("name", "grid"))
```
```{r}
hires_2019_clean %>% 
  filter(start_station_id == "171", end_station_id == "171") %>% 
  count()
```



```{r}
hires_2019_clean %>% 
  select(start_station_id, end_station_id) %>%
  filter(start_station_id == c("248", "259", "265", "289", "257", "262", "249", "247", "171", "183"), 
         end_station_id == c("262", "257", "250", "265", "248", "358", "259", "183", "171", "258")) %>% 
  ggraph(layout = "linear") + 
  geom_edge_arc(edge_colour = "black", edge_alpha = 0.3, edge_width = 0.2) +
  geom_node_point(color = "#F27F1B", size = 10) +
  geom_node_text(aes(label = name), repel = FALSE, size = 3, nudge_y = 0, colour = "white") +
  labs(title = "Journeys between most popular stations\n\n") +
  theme_void() +
  theme(title = element_text(size = 12),
        legend.position = "none",
        plot.margin = unit(rep(1, 4), "cm"))
```
### Journeys based on elevation

68622 downhill journeys
43774 uphill journeys
12050 flat journeys

```{r}
# downhill vs uphill vs flat journeys
# based on elevation of start and end stations

# 68622 downhill journeys
hires_2019_clean %>% 
  filter(elevation_diff < 0) %>% 
  count()

# 43774 uphill journeys
hires_2019_clean %>% 
  filter(elevation_diff > 0) %>% 
  count()

# 12050 flat journeys
hires_2019_clean %>% 
  filter(elevation_diff == 0) %>% 
  count()
```



### Journeys based on weather

According to www.statista.com "A rainday is when one millimetre or more of rain occurs in a day." Based on this I have classified rainy days as days where rainfall as recorded by www.power.larc.nasa.gov/ was equal to or over 1mm in Edinburgh.


```{r}
hires_2019_clean %>% 
  select(start_date, rainfall_mm) %>% 
  ggplot() +
  geom_line(aes(start_date, rainfall_mm), col = "blue") +
  geom_hline(yintercept = 1, col="#F27F1B") +
  labs(x = "\nDate",
       y = "Rainfall (mm)\n",
       title = "Edinburgh's daily rainfall in 2019",
       subtitle = "(Orange line at 1mm, above which we class as rainy day)\n") +
  theme_minimal() +
  theme(title = element_text(size = 12),
        axis.text = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```

### Hypothesis Test

α = 0.05
H0 - Rain makes no difference to bike hires (number of journeys on rainy days - number of journeys on non rainy days = 0)
H1 - Rain has an impact on bike hires (number of journeys on non rainy days - number of journeys on rainy days > 0)

Type of test is one-sample proportion, right-sided.

p value = 0 

The p-value being near to 0 means it is less than α, and so we should reject H0 based on our data. The result is statistically significant in favour of H1, that rain may imapct bike hire numbers.



```{r}
# hypothesis test
# α = 0.05
# H0 - Rain makes no difference to bike hires
# H1 - Rain has an impact on bike hires

rain_day <- hires_2019_clean %>%
  group_by(start_date) %>% 
  mutate(rain_day = rainfall_mm >= 1) %>% 
  select(start_date, rain_day) %>% 
  count(start_date, rain_day)

null_distribution <- rain_day %>%
  specify(response = rain_day, success = "TRUE") %>%
  hypothesize(null = "point", p = 0.05) %>%
  generate(reps = 10000, type = "draw") %>%
  calculate(stat = "prop")

obs_stat <- rain_day %>%
  specify(response = rain_day, success = "TRUE") %>%
  calculate(stat = "prop")

null_distribution %>%
  visualise() +
  shade_p_value(direction = "right", obs_stat = obs_stat)

null_distribution %>%
  get_p_value(direction = "right", obs_stat = obs_stat)

```

```{r}
# bootstrapped hypothesis
# α = 0.05
# H0 - Rain makes no difference to bike hires
# H1 - Rain has an impact on bike hires

rain_day_flag <- rain_day %>%
  mutate(rain_day_flag = if_else(rain_day == "TRUE", 1, 0))

null_distribution <- rain_day_flag %>%
  specify(response = rain_day_flag) %>%
  hypothesize(null = "point", mu = 0.05) %>%
  generate(reps = 10000, type = "bootstrap") %>%
  calculate(stat = "mean")

null_distribution %>%
  visualise() +
  shade_p_value(direction = "right", obs_stat = obs_stat)

null_distribution %>%
  get_p_value(direction = "right", obs_stat = obs_stat)
```

Rainy Days in 2019 = 181
Rainy journeys = 58073
Non rainy journeys = 66373

```{r}
# count the number of days with rainfall equal to or over 1mm
rain_2019_clean %>% 
  filter(rainfall_mm >= 1) %>% 
  count()

# journeys based on rainfall
# based on daily precipitation
hires_2019_clean %>% 
  filter(rainfall_mm >= 1) %>% 
  count()

hires_2019_clean %>% 
  filter(rainfall_mm < 1) %>% 
  count()
```


### Time of Day analysis

Gym Bunnies - before 7am:           7783   23.07 mins   
Morning Commuters - 7am to 9am:     12452  17.87 mins    
Day Trippers - 9am to 5pm:          66880  29.75 mins    
Homeward Bounders - 5pm to 6.30pm:  14961  23.86 mins    
Evening Movers - 6.30pm to 10pm:    16815  23.5 mins    
Pub Ponies - 10pm to Midnight:      5555   20.67 mins   

Average journey time overall is 26.18 minutes

```{r}
# Gym Bunnies - before 7am
hires_2019_clean %>% 
  mutate(start_time = as.character(start_time), end_time = as.character(end_time)) %>% 
  filter(start_time <= "07:00:00") %>% 
  mutate(mean_duration = round(mean(duration), 2)) %>% 
  count(mean_duration)

# Morning Commuters - 7am to 9am
hires_2019_clean %>% 
  mutate(start_time = as.character(start_time), end_time = as.character(end_time)) %>% 
  filter(start_time > "07:00:00", start_time <= "09:00:00") %>% 
  mutate(mean_duration = round(mean(duration), 2)) %>% 
  count(mean_duration)

# Day Trippers - 9am to 5pm
hires_2019_clean %>% 
  mutate(start_time = as.character(start_time), end_time = as.character(end_time)) %>% 
  filter(start_time > "09:00:00", start_time < "17:00:00") %>% 
  mutate(mean_duration = round(mean(duration), 2)) %>% 
  count(mean_duration)

# Homeward Bounders - 5pm to 6.30pm
hires_2019_clean %>% 
  mutate(start_time = as.character(start_time), end_time = as.character(end_time)) %>% 
  filter(start_time >= "17:00:00", start_time <= "18:30:00") %>% 
  mutate(mean_duration = round(mean(duration), 2)) %>% 
  count(mean_duration)

# Evening Movers - 6.30pm to 10pm
hires_2019_clean %>% 
  mutate(start_time = as.character(start_time), end_time = as.character(end_time)) %>% 
  filter(start_time > "18:30:00", start_time < "22:00:00") %>% 
  mutate(mean_duration = round(mean(duration), 2)) %>% 
  count(mean_duration)

# Pub Ponies - 10pm to Midnight
hires_2019_clean %>% 
  mutate(start_time = as.character(start_time), end_time = as.character(end_time)) %>% 
  filter(start_time >= "22:00:00") %>% 
  mutate(mean_duration = round(mean(duration), 2)) %>% 
  count(mean_duration)

# Average journey length
hires_2019_clean %>% 
  mutate(mean_duration = round(mean(duration), 2)) %>% 
  count(mean_duration)

```


```{r}
hires_2019_clean %>% 
  select(start_time) %>%
  group_by(start_time) %>% 
  count() %>%
  ggplot() +
  geom_line(aes(start_time, n), col = "#F27F1B") +
  labs(x = "\nTime of Day",
       y = "Number of Journeys\n",
       title = "Start time of journeys") +
  theme_minimal() +
  theme(title = element_text(size = 12),
        axis.text = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```
